<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prenotazione Barbiere</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Stile Cliente con API PHP */
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; color: #1f2937; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .card-container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 2rem; }
        .info-bar { background-color: #ffffff; padding: 1rem; border: 1px solid #e5e7eb; border-radius: 0.75rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .days-columns-container { display: flex; overflow-x: auto; padding-bottom: 1rem; gap: 1rem; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f0f4f8; }
        .days-columns-container::-webkit-scrollbar { height: 8px; }
        .days-columns-container::-webkit-scrollbar-track { background: #f0f4f8; border-radius: 4px;}
        .days-columns-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; border: 2px solid #f0f4f8; }
        .day-column { flex: 0 0 180px; background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
        .day-header { text-align: center; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .day-name { display: block; font-size: 0.875rem; }
        .day-date-num { display: block; font-size: 0.75rem; color: #6b7280; }
        .time-slot { display: block; width: 100%; text-align: center; padding: 0.6rem 0.5rem; margin-bottom: 0.5rem; border-radius: 1.5rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border: none; background-color: #e0f2fe; color: #0c4a6e; }
        .time-slot:hover:not(.booked):not(.disabled) { background-color: #bae6fd; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .booked { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; opacity: 0.8; }
        .disabled { background-color: #f3f4f6; color: #cbd5e1; cursor: not-allowed; opacity: 0.7; }
        .message { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.375rem; font-weight: 500; border: 1px solid; }
        .message-error { background-color: #fef2f2; color: #991b1b; border-color: #fca5a5; }
        .message-success { background-color: #f0fdf4; color: #14532d; border-color: #86efac; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; border: 1px solid transparent; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #111827; color: #ffffff; border-color: #111827; }
        .btn-primary:hover { background-color: #374151; border-color: #374151; }
        .btn-secondary { background-color: #ffffff; color: #1f2937; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03); }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .btn-danger { background-color: #ffffff; color: #991b1b; border: 1px solid #fca5a5; }
        .btn-danger:hover { background-color: #fef2f2; border-color: #ef4444; }
        .text-link { color: #374151; text-decoration: none; font-weight: 500; cursor: pointer; }
        .text-link:hover { text-decoration: underline; color: #000000; }
        input[type="text"], input[type="password"], textarea { background-color: #ffffff; border: 1px solid #d1d5db; color: #111827; border-radius: 0.375rem; padding: 0.625rem 0.75rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; width: 100%; }
        input[type="text"]::placeholder, input[type="password"]::placeholder, textarea::placeholder { color: #9ca3af; }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: none; border-color: #374151; box-shadow: 0 0 0 2px rgba(55, 65, 81, 0.1); }
        h1 { color: #000000; font-weight: 700; }
        h2 { color: #111827; font-weight: 600; margin-bottom: 1.5rem; }
        p { color: #4b5563; line-height: 1.6; }
        #loggedInInfo p { color: #374151; }
        #loggedInInfo strong { color: #000000; font-weight: 600; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: #ffffff; padding: 2rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-close-btn:hover { color: #111827; }
    </style>
</head>
<body class="container mx-auto p-4 md:p-8">

    <div class="flex justify-center mb-10">
        <img src="logosenzasfondo.png" alt="Logo Barbiere" class="h-20">
    </div>

    <h1 class="text-3xl md:text-4xl font-bold text-center mb-10">Prenota il tuo appuntamento</h1>

    <div id="messageArea" class="mb-4 max-w-md mx-auto"></div>

    <div id="authSection" class="card-container max-w-md mx-auto">
        <div id="loginForm">
            <h2 class="text-2xl text-center">Accedi</h2>
            <input type="text" id="loginUsername" placeholder="Username" class="w-full p-3 mb-4">
            <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 mb-5">
            <button onclick="loginUser()" class="w-full btn btn-primary mb-4">Accedi</button>
            <p class="text-center text-sm">
                Non hai un account? <button onclick="showSignupForm()" class="text-link">Registrati</button>
            </p>
        </div>
        <div id="signupForm" style="display: none;">
            <h2 class="text-2xl text-center">Registrati</h2>
            <input type="text" id="signupUsername" placeholder="Scegli Username" class="w-full p-3 mb-4">
            <input type="password" id="signupPassword" placeholder="Scegli Password" class="w-full p-3 mb-5">
            <button onclick="signupUser()" class="w-full btn btn-secondary mb-4">Registrati</button>
             <p class="text-center text-sm">
                Hai gi√† un account? <button onclick="showLoginForm()" class="text-link">Accedi</button>
            </p>
        </div>
    </div>

    <div id="bookingSection" style="display: none;" class="w-full mx-auto">
        <div id="loggedInInfo" class="info-bar mb-6 flex justify-between items-center max-w-4xl mx-auto">
             <p class="text-base">Benvenuto, <strong id="loggedInUsername"></strong>!</p>
             <button onclick="logoutUser()" class="btn btn-danger !py-1 !px-3 text-sm">Logout</button>
        </div>
        <div id="daysColumnsContainer" class="days-columns-container px-4">
            <p id="columnsLoading" class="w-full text-center text-gray-500 p-4">Caricamento calendario...</p>
        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content relative">
             <button onclick="closeBookingModal()" class="modal-close-btn" aria-label="Chiudi modal">&times;</button>
            <h3 class="text-xl font-semibold mb-4 text-center">Conferma Prenotazione</h3>
            <p class="text-center mb-4">Stai prenotando per le <strong id="modalTimeSlot"></strong> di <strong id="modalDateDisplay"></strong>.</p>
            <div class="mb-4">
                <label for="bookingComment" class="block text-sm font-medium text-gray-700 mb-1">Aggiungi un commento (opzionale):</label>
                <textarea id="bookingComment" name="bookingComment" rows="3" placeholder="Es. tipo di taglio, preferenze..." class="w-full"></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="closeBookingModal()" class="btn btn-secondary">Annulla</button>
                <button onclick="confirmBookingWithComment()" class="btn btn-primary">Conferma Prenotazione</button>
            </div>
        </div>
    </div>


    <script>
        // --- Configurazione ---
        const START_HOUR = 9;
        const END_HOUR = 18;
        const DAYS_TO_SHOW = 7;
        const API_URL = 'api.php'; // Assicurati che il percorso sia corretto
        const STORAGE_KEYS = {
            LOGGED_IN_USER: 'barberBookings_loggedInUser_ss' // Solo per sessionStorage
        };

        // --- Elementi DOM ---
        const authSection = document.getElementById('authSection');
        const bookingSection = document.getElementById('bookingSection');
        const loggedInUsernameSpan = document.getElementById('loggedInUsername');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const messageArea = document.getElementById('messageArea');
        const bookingModal = document.getElementById('bookingModal');
        const modalTimeSlotSpan = document.getElementById('modalTimeSlot');
        const modalDateDisplaySpan = document.getElementById('modalDateDisplay');
        const bookingCommentTextarea = document.getElementById('bookingComment');
        const daysColumnsContainer = document.getElementById('daysColumnsContainer');
        const columnsLoading = document.getElementById('columnsLoading');

        // Verifica elementi critici
        if (!authSection || !bookingSection || !loginForm || !signupForm || !messageArea || !bookingModal || !daysColumnsContainer || !columnsLoading) {
            console.error("ERRORE CRITICO: Elementi HTML base mancanti!");
        }

        // --- Stato Applicazione ---
        let tempBookingData = { date: null, time: null };
        let currentBookingsCache = []; // Cache delle prenotazioni caricate dal server

        // --- Funzioni Helper ---
        // getData e saveData non servono pi√π per dati persistenti
        function showMessage(text, type = 'error') {
             if (!messageArea) return;
             console.log(`Mostrando messaggio (${type}): ${text}`);
             while (messageArea.firstChild) { messageArea.removeChild(messageArea.firstChild); }
             const messageDiv = document.createElement('div');
             messageDiv.className = `message message-${type}`;
             messageDiv.textContent = text;
             messageArea.appendChild(messageDiv);
             setTimeout(() => { if (messageArea.contains(messageDiv)) { messageArea.removeChild(messageDiv); } }, 5000);
        }
        function formatDateYYYYMMDD(date) {
             if (!(date instanceof Date) || isNaN(date)) { console.error("formatDateYYYYMMDD: data non valida:", date); return null; }
             const year = date.getFullYear();
             const month = String(date.getMonth() + 1).padStart(2, '0');
             const day = String(date.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
         }
        function formatDisplayDate(dateString) {
             if (!dateString || typeof dateString !== 'string') return 'Data non valida';
             try {
                 const [year, month, day] = dateString.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || isNaN(day)) return dateString;
                 const dateObj = new Date(year, month - 1, day);
                 if (isNaN(dateObj.getTime())) return dateString;
                 const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                 let formatted = dateObj.toLocaleDateString('it-IT', options);
                 return formatted.charAt(0).toUpperCase() + formatted.slice(1);
             } catch (e) { console.error("Errore formattazione data:", dateString, e); return dateString; }
         }
        function getTodayAtMidnight() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
         }
        function formatDayHeader(dateString) {
             if (!dateString || typeof dateString !== 'string') return { dayName: 'Err', shortDate: '' };
             try {
                 const [year, month, day] = dateString.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || isNaN(day)) return { dayName: 'Err', shortDate: '' };
                 const dateObj = new Date(year, month - 1, day);
                 if (isNaN(dateObj.getTime())) return { dayName: 'Err', shortDate: '' };
                 const dayName = dateObj.toLocaleDateString('it-IT', { weekday: 'short' }).toUpperCase();
                 const shortDate = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }).toUpperCase();
                 return { dayName, shortDate };
             } catch (e) { console.error("Errore formattazione header giorno:", dateString, e); return { dayName: 'Err', shortDate: '' }; }
        }

        // --- Logica di Autenticazione (con Fetch) ---
        function showSignupForm() {
            if (!loginForm || !signupForm) return;
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            if(messageArea) messageArea.innerHTML = '';
        }
        function showLoginForm() {
             if (!loginForm || !signupForm) return;
            signupForm.style.display = 'none';
            loginForm.style.display = 'block';
            if(messageArea) messageArea.innerHTML = '';
        }
        async function signupUser() {
            console.log("signupUser chiamata");
            const usernameInput = document.getElementById('signupUsername');
            const passwordInput = document.getElementById('signupPassword');
            if (!usernameInput || !passwordInput) { console.error("Input signup non trovati!"); return; }
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) { showMessage('Per favore, inserisci username e password.'); return; }

            const formData = new FormData();
            formData.append('action', 'signup');
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await response.json(); // Leggi sempre la risposta

                if (!response.ok) { // Controlla se la risposta HTTP √® OK (es. 200)
                     throw new Error(result.message || `Errore HTTP: ${response.status}`);
                }

                if (result.success) {
                    showMessage(result.message || 'Registrazione avvenuta con successo! Ora puoi accedere.', 'success');
                    usernameInput.value = ''; passwordInput.value = '';
                    showLoginForm();
                } else {
                    showMessage(result.message || 'Errore durante la registrazione.');
                }
            } catch (error) {
                console.error("Errore fetch signup:", error);
                showMessage(error.message || "Errore di comunicazione con il server.", "error");
            }
        }
        async function loginUser() {
            console.log("loginUser chiamata");
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
             if (!usernameInput || !passwordInput) { console.error("Input login non trovati!"); return; }
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) { showMessage('Per favore, inserisci username e password.'); return; }

            const formData = new FormData();
            formData.append('action', 'login');
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await response.json();

                if (!response.ok) {
                     throw new Error(result.message || `Errore HTTP: ${response.status}`);
                }

                if (result.success && result.username) {
                     console.log("Login riuscito per utente:", result.username);
                     try { sessionStorage.setItem(STORAGE_KEYS.LOGGED_IN_USER, result.username); }
                     catch(e) { console.error("Errore scrittura sessionStorage:", e); /* Non bloccare */ }
                    usernameInput.value = ''; passwordInput.value = '';
                    initializeApp();
                } else {
                    // L'errore viene gestito dal catch se response.ok √® false
                    // Se response.ok √® true ma success √® false (caso strano)
                    console.log("Login fallito:", result.message);
                    showMessage(result.message || 'Username o password non validi.');
                }
            } catch (error) {
                console.error("Errore fetch login:", error);
                showMessage(error.message || "Errore di comunicazione con il server.", "error");
            }
        }
        function logoutUser() {
             console.log("logoutUser chiamata");
             try { sessionStorage.removeItem(STORAGE_KEYS.LOGGED_IN_USER); }
             catch (e) { console.error("Errore rimozione sessionStorage:", e); }
            currentBookingsCache = []; // Pulisci cache
            tempBookingData = { date: null, time: null };
            initializeApp();
        }
        function getLoggedInUser() {
             try { return sessionStorage.getItem(STORAGE_KEYS.LOGGED_IN_USER); }
             catch (e) { console.error("Errore lettura sessionStorage:", e); return null; }
        }

        // --- Logica Modal Prenotazione ---
        function openBookingModal(date, time) {
             if (!modalTimeSlotSpan || !modalDateDisplaySpan || !bookingCommentTextarea || !bookingModal) return;
            tempBookingData.date = date;
            tempBookingData.time = time;
            modalTimeSlotSpan.textContent = time;
            modalDateDisplaySpan.textContent = formatDisplayDate(date);
            bookingCommentTextarea.value = '';
            bookingModal.classList.add('active');
        }
        function closeBookingModal() {
             if (!bookingModal) return;
            bookingModal.classList.remove('active');
            tempBookingData.date = null;
            tempBookingData.time = null;
        }

        // --- Logica delle Prenotazioni (con Fetch) ---
        async function fetchBookings() {
             console.log("fetchBookings: Caricamento...");
             try {
                 const response = await fetch(`${API_URL}?action=getBookings`);
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.message || `Errore HTTP: ${response.status}`);

                 if (result.success && Array.isArray(result.bookings)) {
                     currentBookingsCache = result.bookings;
                     console.log(`fetchBookings: Caricate ${currentBookingsCache.length} prenotazioni.`);
                     return true;
                 } else {
                     console.error("fetchBookings: Risposta non valida:", result);
                     showMessage("Errore caricamento prenotazioni.", "error");
                     currentBookingsCache = []; return false;
                 }
             } catch (error) {
                 console.error("Errore fetch getBookings:", error);
                 showMessage(error.message || "Errore di comunicazione.", "error");
                 currentBookingsCache = []; return false;
             }
        }
        function generateTimeSlotsForDay(dateString, columnElement) {
            const slotsContainer = columnElement.querySelector('.time-slots-wrapper');
            if (!slotsContainer) { console.error("Contenitore slot non trovato:", dateString); return; }
            slotsContainer.innerHTML = '';

            const bookings = currentBookingsCache; // Usa la cache

            const now = new Date();
            const today = getTodayAtMidnight();
            const [year, month, day] = dateString.split('-').map(Number);
            const selectedDayMidnight = new Date(year, month - 1, day);
            const isToday = selectedDayMidnight.getTime() === today.getTime();
            const isPastDay = selectedDayMidnight < today;

            let slotsGenerated = 0;
            for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                const time = `${String(hour).padStart(2, '0')}:00`;
                const isBooked = bookings.some(booking => booking && booking.date === dateString && booking.time === time);
                let isPastTime = false;
                if (isToday) { isPastTime = hour < now.getHours(); }
                if (isPastDay) continue;

                const slotElement = document.createElement('button');
                slotElement.textContent = time;
                slotElement.classList.add('time-slot');
                if (isBooked) {
                    slotElement.classList.add('booked'); slotElement.title = 'Gi√† prenotato'; slotElement.disabled = true;
                } else if (isPastTime) {
                     slotElement.classList.add('disabled'); slotElement.title = 'Passato'; slotElement.disabled = true;
                } else {
                    slotElement.classList.add('available'); slotElement.onclick = () => openBookingModal(dateString, time); slotElement.title = 'Prenota';
                }
                slotsContainer.appendChild(slotElement);
                slotsGenerated++;
            }
             if (slotsGenerated === 0) {
                 slotsContainer.innerHTML = '<p class="text-xs text-center text-gray-400 py-4">Nessun orario disponibile.</p>';
             }
        }
        function createDayColumns() {
            if (!daysColumnsContainer || !columnsLoading) return;
            daysColumnsContainer.innerHTML = '';
            columnsLoading.style.display = 'block';

            const today = getTodayAtMidnight();
            const datesToShow = [];
            for (let i = 0; i < DAYS_TO_SHOW; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateStr = formatDateYYYYMMDD(date);
                if(dateStr) datesToShow.push(dateStr);
            }

             if (datesToShow.length === 0) { columnsLoading.textContent = 'Nessun giorno disponibile.'; return; }

            datesToShow.forEach(dateString => {
                const column = document.createElement('div');
                column.classList.add('day-column');
                column.dataset.date = dateString;
                const { dayName, shortDate } = formatDayHeader(dateString);
                column.innerHTML = `
                    <div class="day-header"><span class="day-name">${dayName}</span><span class="day-date-num">${shortDate}</span></div>
                    <div class="time-slots-wrapper">{/* Popolato da generateTimeSlotsForDay */}</div>`;
                daysColumnsContainer.appendChild(column);
                // Genera slot usando la cache (che dovrebbe essere stata caricata)
                generateTimeSlotsForDay(dateString, column);
            });
            columnsLoading.style.display = 'none';
        }
        async function confirmBookingWithComment() {
            const loggedInUser = getLoggedInUser();
            const { date, time } = tempBookingData;
            const comment = bookingCommentTextarea.value.trim();

            if (!loggedInUser || !date || !time) { showMessage('Errore: Dati prenotazione mancanti.'); closeBookingModal(); return; }

            const formData = new FormData();
            formData.append('action', 'addBooking');
            formData.append('date', date);
            formData.append('time', time);
            formData.append('user', loggedInUser);
            formData.append('comment', comment);

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.message || `Errore HTTP: ${response.status}`);

                 if (result.success) {
                     showMessage(result.message || 'Prenotazione confermata!', 'success');
                     closeBookingModal();
                     await fetchBookings(); // Aggiorna cache
                     const columnToUpdate = daysColumnsContainer.querySelector(`.day-column[data-date="${date}"]`);
                     if (columnToUpdate) generateTimeSlotsForDay(date, columnToUpdate);
                 } else {
                     showMessage(result.message || 'Errore durante la prenotazione.');
                     if (result.message && result.message.toLowerCase().includes('gi√† prenotata')) {
                          closeBookingModal();
                          await fetchBookings();
                           const columnToUpdate = daysColumnsContainer.querySelector(`.day-column[data-date="${date}"]`);
                           if (columnToUpdate) generateTimeSlotsForDay(date, columnToUpdate);
                     }
                 }
            } catch (error) {
                 console.error("Errore fetch addBooking:", error);
                 showMessage(error.message || "Errore di comunicazione.", "error");
            }
        }

        // --- Inizializzazione ---
        async function initializeApp() {
             console.log("initializeApp Cliente chiamata");
             if (!authSection || !bookingSection || !daysColumnsContainer) { console.error("ERRORE CRITICO: Elementi HTML mancanti!"); return; }
             try {
                const loggedInUser = getLoggedInUser();
                console.log("Utente loggato (sessionStorage):", loggedInUser);
                if (loggedInUser) {
                    authSection.style.display = 'none';
                    bookingSection.style.display = 'block';
                    if (loggedInUsernameSpan) loggedInUsernameSpan.textContent = loggedInUser;
                    const bookingsLoaded = await fetchBookings(); // Carica dati
                    if (bookingsLoaded) {
                        createDayColumns(); // Crea colonne e popola slot
                    } else {
                         if(columnsLoading) columnsLoading.textContent = 'Impossibile caricare il calendario.';
                    }
                } else {
                    authSection.style.display = 'block';
                    bookingSection.style.display = 'none';
                }
             } catch (e) {
                 console.error("Errore durante l'inizializzazione:", e);
                 showMessage("Si √® verificato un errore caricando l'app.", "error");
                 if(authSection) authSection.style.display = 'block';
                 if(bookingSection) bookingSection.style.display = 'none';
             } finally {
                 if(messageArea) messageArea.innerHTML = '';
                 closeBookingModal();
                 console.log("initializeApp Cliente completata.");
             }
        }

        // Esegui all'avvio
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Chiudi il modal cliccando fuori
        if (bookingModal) {
            bookingModal.addEventListener('click', (event) => {
                if (event.target === bookingModal) { closeBookingModal(); }
            });
        }

    </script>

</body>
</html>
