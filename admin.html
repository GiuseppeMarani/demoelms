<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Barbiere - Prenotazioni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Stile Admin con Colonne Calendario e API PHP */
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f8; color: #1f2937; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .card-container { background-color: #ffffff; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-top: 2rem; }
        .login-card { background-color: #ffffff; padding: 2rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03); margin-top: 2rem; }
        .message { padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0.375rem; font-weight: 500; border: 1px solid; }
        .message-error { background-color: #fef2f2; color: #991b1b; border-color: #fca5a5; }
        .message-info { background-color: #f0fdf4; color: #14532d; border-color: #86efac; }
        .btn { padding: 0.625rem 1.25rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s ease-in-out; border: 1px solid transparent; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #111827; color: #ffffff; border-color: #111827; }
        .btn-primary:hover { background-color: #374151; border-color: #374151; }
        .btn-danger { background-color: #ffffff; color: #991b1b; border: 1px solid #fca5a5; }
        .btn-danger:hover { background-color: #fef2f2; border-color: #ef4444; }
        .btn-secondary { background-color: #ffffff; color: #1f2937; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03); }
        .btn-secondary:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .btn-comment-admin { display: block; width: 100%; text-align: center; margin-top: 0.5rem; padding: 0.2rem 0.5rem; font-size: 0.7rem; background-color: #e5e7eb; color: #4b5563; border: 1px solid #d1d5db; border-radius: 0.25rem; }
        .btn-comment-admin:hover { background-color: #d1d5db; }
        input[type="password"] { background-color: #ffffff; border: 1px solid #d1d5db; color: #111827; border-radius: 0.375rem; padding: 0.625rem 0.75rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; width: 100%; }
        input[type="password"]::placeholder { color: #9ca3af; }
        input[type="password"]:focus { outline: none; border-color: #374151; box-shadow: 0 0 0 2px rgba(55, 65, 81, 0.1); }
        h1 { color: #000000; font-weight: 700; }
        h2 { color: #111827; font-weight: 600; margin-bottom: 1.5rem; }
        p { color: #4b5563; }
        .note-text { color: #6b7280; font-size: 0.75rem; }
        .days-columns-container { display: flex; overflow-x: auto; padding-bottom: 1rem; gap: 1rem; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #cbd5e1 #f0f4f8; margin-top: 1.5rem; }
        .days-columns-container::-webkit-scrollbar { height: 8px; }
        .days-columns-container::-webkit-scrollbar-track { background: #f0f4f8; border-radius: 4px;}
        .days-columns-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; border: 2px solid #f0f4f8; }
        .day-column { flex: 0 0 200px; background-color: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.06); }
        .day-header { text-align: center; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .day-name { display: block; font-size: 0.875rem; }
        .day-date-num { display: block; font-size: 0.75rem; color: #6b7280; }
        .admin-booking-slot { background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem; font-size: 0.875rem; }
        .admin-booking-time { font-weight: 600; color: #111827; display: block; margin-bottom: 0.25rem; }
        .admin-booking-user { color: #4b5563; display: block; word-break: break-all; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: #ffffff; padding: 2rem; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 600px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; background: none; border: none; font-size: 1.5rem; color: #9ca3af; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .modal-close-btn:hover { color: #111827; }
        .comment-display { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem 1rem; margin-top: 0.5rem; min-height: 60px; white-space: pre-wrap; word-wrap: break-word; color: #374151; }
        .comment-display.empty { font-style: italic; color: #9ca3af; }
    </style>
</head>
<body class="container mx-auto p-4 md:p-8">

     <div class="flex justify-center mb-10">
        <img src="logosenzasfondo.png" alt="Logo Barbiere" class="h-20">
     </div>

    <h1 class="text-3xl md:text-4xl font-bold text-center mb-10">Dashboard Amministratore</h1>

     <div id="messageArea" class="mb-4 max-w-md mx-auto"></div>

    <div id="adminLoginSection" class="login-card max-w-sm mx-auto">
        <h2 class="text-2xl text-center">Accesso Barbiere</h2>
        <input type="password" id="adminPassword" placeholder="Password Amministratore" class="w-full p-3 mb-5">
        <button onclick="loginAdmin()" class="w-full btn btn-primary">Accedi</button>
    </div>

    <div id="adminDashboardSection" style="display: none;" class="w-full mx-auto">
         <div class="flex justify-between items-center mb-4 max-w-6xl mx-auto px-4">
            <h2 class="text-2xl font-semibold text-gray-800">Prenotazioni</h2>
            <button onclick="logoutAdmin()" class="btn btn-danger !py-1 !px-3 text-sm">Logout</button>
        </div>
        <div id="daysColumnsContainer" class="days-columns-container px-4">
            <p id="columnsLoading" class="w-full text-center text-gray-500 p-4">Caricamento calendario...</p>
        </div>
         <p id="noBookingsMessage" class="text-center note-text mt-6" style="display: none;">Nessuna prenotazione trovata.</p>
    </div>

    <div id="commentModal" class="modal-overlay">
         <div class="modal-content relative">
             <button onclick="closeCommentModal()" class="modal-close-btn" aria-label="Chiudi modal">&times;</button>
            <h3 class="text-xl font-semibold mb-4">Dettagli Prenotazione</h3>
            <div class="grid grid-cols-3 gap-x-4 mb-3 text-sm">
                <div><span class="font-semibold block text-gray-500">Data:</span><span id="modalBookingDate"></span></div>
                <div><span class="font-semibold block text-gray-500">Ora:</span><span id="modalBookingTime"></span></div>
                <div><span class="font-semibold block text-gray-500">Utente:</span><span id="modalBookingUser"></span></div>
            </div>
            <div>
                <label class="block text-sm font-semibold text-gray-500 mb-1">Commento:</label>
                <div id="modalBookingComment" class="comment-display"></div>
            </div>
            <div class="flex justify-end mt-6"><button onclick="closeCommentModal()" class="btn btn-secondary">Chiudi</button></div>
        </div>
    </div>


    <script>
        // --- Configurazione ---
        const API_URL = 'api.php'; // URL dello script PHP
        const STORAGE_KEYS = {
            // Non usiamo più localStorage per i dati, solo sessionStorage per lo stato login admin
            ADMIN_LOGGED_IN: 'barberBookings_adminLoggedIn_ss'
        };

         // --- Elementi DOM ---
        const adminLoginSection = document.getElementById('adminLoginSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');
        const messageArea = document.getElementById('messageArea');
        const commentModal = document.getElementById('commentModal');
        const modalBookingDate = document.getElementById('modalBookingDate');
        const modalBookingTime = document.getElementById('modalBookingTime');
        const modalBookingUser = document.getElementById('modalBookingUser');
        const modalBookingComment = document.getElementById('modalBookingComment');
        const daysColumnsContainer = document.getElementById('daysColumnsContainer');
        const columnsLoading = document.getElementById('columnsLoading');
        const noBookingsMessage = document.getElementById('noBookingsMessage');

        // Verifica elementi critici
        if (!adminLoginSection || !adminDashboardSection || !messageArea || !commentModal || !daysColumnsContainer || !columnsLoading || !noBookingsMessage) {
            console.error("ERRORE CRITICO: Elementi HTML admin mancanti!");
        }

        // --- Stato Applicazione ---
        let allBookingsCache = []; // Cache prenotazioni caricate
        let sortedBookedDates = []; // Date uniche ordinate

        // --- Funzioni Helper ---
        // getData e saveData non servono più qui
        function showMessage(text, type = 'error') {
             if (!messageArea) return;
             console.log(`Mostrando messaggio (${type}): ${text}`);
             while (messageArea.firstChild) { messageArea.removeChild(messageArea.firstChild); }
             const messageDiv = document.createElement('div');
             messageDiv.className = `message message-${type}`;
             messageDiv.textContent = text;
             messageArea.appendChild(messageDiv);
             setTimeout(() => { if (messageArea.contains(messageDiv)) { messageArea.removeChild(messageDiv); } }, 5000);
        }
         function formatDisplayDate(dateString) {
             if (!dateString || typeof dateString !== 'string') return 'Data non valida';
             try {
                 const [year, month, day] = dateString.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || isNaN(day)) return dateString;
                 const dateObj = new Date(year, month - 1, day);
                 if (isNaN(dateObj.getTime())) return dateString;
                 const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                 let formatted = dateObj.toLocaleDateString('it-IT', options);
                 return formatted.charAt(0).toUpperCase() + formatted.slice(1);
             } catch (e) { console.error("Errore formattazione data:", dateString, e); return dateString; }
         }
        function formatDayHeader(dateString) {
             if (!dateString || typeof dateString !== 'string') return { dayName: 'Err', shortDate: '' };
             try {
                 const [year, month, day] = dateString.split('-').map(Number);
                 if (isNaN(year) || isNaN(month) || isNaN(day)) return { dayName: 'Err', shortDate: '' };
                 const dateObj = new Date(year, month - 1, day);
                 if (isNaN(dateObj.getTime())) return { dayName: 'Err', shortDate: '' };
                 const dayName = dateObj.toLocaleDateString('it-IT', { weekday: 'short' }).toUpperCase();
                 const shortDate = dateObj.toLocaleDateString('it-IT', { day: '2-digit', month: 'short' }).toUpperCase();
                 return { dayName, shortDate };
             } catch (e) { console.error("Errore formattazione header giorno:", dateString, e); return { dayName: 'Err', shortDate: '' }; }
        }

        // --- Logica Modal Commento ---
        function openCommentModal(dateString, bookingIndexOnPage) {
             if (!dateString) { console.error("openCommentModal: Data non fornita."); return; }
             const bookingsForDate = allBookingsCache.filter(b => b && b.date === dateString);
             if (bookingIndexOnPage < 0 || bookingIndexOnPage >= bookingsForDate.length) { console.error("openCommentModal: Indice non valido:", bookingIndexOnPage); return; }
             const booking = bookingsForDate[bookingIndexOnPage];
            if (!booking) { console.error("openCommentModal: Prenotazione non trovata."); return; }
            if (!modalBookingDate || !modalBookingTime || !modalBookingUser || !modalBookingComment || !commentModal) { return; }

            modalBookingDate.textContent = formatDisplayDate(booking.date) || 'N/D';
            modalBookingTime.textContent = booking.time || 'N/D';
            modalBookingUser.textContent = booking.user || 'N/D';
            const commentDisplay = modalBookingComment;
            if (booking.comment && booking.comment.trim() !== '') {
                commentDisplay.textContent = booking.comment;
                commentDisplay.classList.remove('empty');
            } else {
                commentDisplay.textContent = 'Nessun commento lasciato.';
                commentDisplay.classList.add('empty');
            }
            commentModal.classList.add('active');
        }
        function closeCommentModal() {
            if (!commentModal) return;
            commentModal.classList.remove('active');
        }


        // --- Logica Admin (con Fetch e sessionStorage) ---
        async function loginAdmin() {
            console.log("loginAdmin chiamata"); // Debug
            const passwordInput = document.getElementById('adminPassword');
            if (!passwordInput) { console.error("Input password non trovato!"); return; }
            const password = passwordInput.value;

            if (!password) { showMessage('Inserisci la password amministratore.'); return; }

            const formData = new FormData();
            formData.append('action', 'adminLogin');
            formData.append('password', password);

            try {
                const response = await fetch(API_URL, { method: 'POST', body: formData });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || `Errore HTTP: ${response.status}`);

                if (result.success) {
                    console.log("Admin login riuscito."); // Debug
                    try { sessionStorage.setItem(STORAGE_KEYS.ADMIN_LOGGED_IN, 'true'); }
                    catch(e) { console.error("Errore scrittura sessionStorage:", e); /* Non bloccare */ }
                    passwordInput.value = '';
                    if(messageArea) messageArea.innerHTML = '';
                    initializeApp(); // Mostra dashboard
                } else {
                     // Gestito dal catch se response.ok è false
                    showMessage(result.message || 'Password amministratore errata.'); // Mostra messaggio specifico se presente
                    passwordInput.value = '';
                }
            } catch (error) {
                 console.error("Errore fetch adminLogin:", error);
                 showMessage(error.message || "Errore di comunicazione con il server.", "error");
                 passwordInput.value = '';
            }
        }
        function logoutAdmin() {
             console.log("logoutAdmin chiamata"); // Debug
             try { sessionStorage.removeItem(STORAGE_KEYS.ADMIN_LOGGED_IN); }
             catch(e) { console.error("Errore rimozione sessionStorage:", e); }
             // Pulisci cache e stato
             allBookingsCache = [];
             sortedBookedDates = [];
             initializeApp(); // Torna al login
        }
        function isAdminLoggedIn() {
             try { return sessionStorage.getItem(STORAGE_KEYS.ADMIN_LOGGED_IN) === 'true'; }
             catch(e) { console.error("Errore lettura sessionStorage:", e); return false; }
        }

        // --- Logica Visualizzazione Colonne Calendario (con Fetch) ---

        // Carica prenotazioni admin dal server
        async function fetchAdminBookings() {
             console.log("fetchAdminBookings: Caricamento...");
             try {
                 const response = await fetch(`${API_URL}?action=getAdminBookings`); // Usa GET
                 const result = await response.json();
                 if (!response.ok) throw new Error(result.message || `Errore HTTP: ${response.status}`);

                 if (result.success && Array.isArray(result.bookings)) {
                     allBookingsCache = result.bookings; // Aggiorna cache globale
                     // Estrai e ordina le date uniche dalla cache aggiornata
                     const uniqueDates = [...new Set(allBookingsCache.map(b => b.date).filter(Boolean))];
                     sortedBookedDates = uniqueDates.sort();
                     console.log(`fetchAdminBookings: Caricate ${allBookingsCache.length} prenotazioni per ${sortedBookedDates.length} giorni.`);
                     return true; // Successo
                 } else {
                     console.error("fetchAdminBookings: Risposta non valida:", result);
                     showMessage("Errore nel caricare le prenotazioni.", "error");
                     allBookingsCache = []; sortedBookedDates = []; return false;
                 }
             } catch (error) {
                 console.error("Errore fetch getAdminBookings:", error);
                 showMessage(error.message || "Errore di comunicazione.", "error");
                 allBookingsCache = []; sortedBookedDates = []; return false;
             }
        }


        // Genera gli slot per una specifica colonna/giorno usando la cache
        function generateAdminTimeSlotsForDay(dateString, columnElement) {
            const slotsContainer = columnElement.querySelector('.time-slots-wrapper');
            if (!slotsContainer) { console.error("Contenitore slot non trovato:", dateString); return; }
            slotsContainer.innerHTML = '';

            const bookingsForDay = allBookingsCache.filter(b => b && b.date === dateString);
            bookingsForDay.sort((a, b) => (a?.time || '').localeCompare(b?.time || ''));

            if (bookingsForDay.length === 0) {
                slotsContainer.innerHTML = '<p class="text-xs text-center text-gray-400 py-4">Nessuna prenotazione.</p>';
                return;
            }
            bookingsForDay.forEach((booking, index) => {
                const slotDiv = document.createElement('div');
                slotDiv.classList.add('admin-booking-slot');
                const displayTime = booking?.time || 'N/D';
                const displayUser = booking?.user || 'N/D';
                const hasComment = booking && typeof booking.comment === 'string' && booking.comment.trim() !== '';
                let commentButtonHTML = '';
                if (hasComment) {
                    commentButtonHTML = `<button class="btn-comment-admin" onclick="openCommentModal('${dateString}', ${index})">Vedi Commento</button>`;
                }
                slotDiv.innerHTML = `<span class="admin-booking-time">${displayTime}</span><span class="admin-booking-user">${displayUser}</span>${commentButtonHTML}`;
                slotsContainer.appendChild(slotDiv);
            });
        }

        // Crea e popola le colonne dei giorni, poi popola gli slot usando la cache
        function createAdminDayColumns() {
            if (!daysColumnsContainer || !columnsLoading || !noBookingsMessage) return;
            daysColumnsContainer.innerHTML = '';
            columnsLoading.style.display = 'block';
            noBookingsMessage.style.display = 'none';

            // Usa sortedBookedDates popolato da fetchAdminBookings
            if (sortedBookedDates.length === 0) {
                columnsLoading.style.display = 'none';
                noBookingsMessage.textContent = "Nessuna prenotazione futura trovata.";
                noBookingsMessage.style.display = 'block';
                return;
            }

            sortedBookedDates.forEach(dateString => {
                if (!dateString) return;
                const column = document.createElement('div');
                column.classList.add('day-column');
                column.dataset.date = dateString;
                const { dayName, shortDate } = formatDayHeader(dateString);
                column.innerHTML = `
                    <div class="day-header"><span class="day-name">${dayName}</span><span class="day-date-num">${shortDate}</span></div>
                    <div class="time-slots-wrapper">{/* Popolato da generateAdminTimeSlotsForDay */}</div>`;
                daysColumnsContainer.appendChild(column);
                // Genera slot usando la cache
                generateAdminTimeSlotsForDay(dateString, column);
            });
            columnsLoading.style.display = 'none';
        }


        // --- Inizializzazione ---
        async function initializeApp() {
             console.log("initializeApp Admin chiamata");
             if (!adminLoginSection || !adminDashboardSection || !daysColumnsContainer) { console.error("ERRORE CRITICO: Elementi HTML admin mancanti!"); return; }
             try {
                 // Non serve clearOldBookings qui, lo fa PHP su getAdminBookings

                 if (isAdminLoggedIn()) {
                    console.log("Admin loggato, carico dati...");
                    adminLoginSection.style.display = 'none';
                    adminDashboardSection.style.display = 'block';

                    // Carica le prenotazioni (che include la pulizia lato server)
                    const bookingsLoaded = await fetchAdminBookings();
                    if (bookingsLoaded) {
                        createAdminDayColumns(); // Crea le colonne con i dati caricati
                    } else {
                        if(columnsLoading) columnsLoading.textContent = 'Impossibile caricare le prenotazioni.';
                        if(noBookingsMessage) noBookingsMessage.style.display = 'block'; // Mostra messaggio se fetch fallisce
                    }

                } else {
                    console.log("Admin non loggato.");
                    adminLoginSection.style.display = 'block';
                    adminDashboardSection.style.display = 'none';
                }
             } catch (e) {
                 console.error("Errore durante l'inizializzazione dell'app admin:", e);
                 showMessage("Si è verificato un errore imprevisto.", "error");
                 if(adminLoginSection) adminLoginSection.style.display = 'block';
                 if(adminDashboardSection) adminDashboardSection.style.display = 'none';
             } finally {
                 if (!isAdminLoggedIn() && messageArea) messageArea.innerHTML = '';
                 closeCommentModal();
                 console.log("initializeApp Admin completata.");
             }
         }

        // Esegui all'avvio
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Chiudi il modal cliccando fuori
        if (commentModal) {
            commentModal.addEventListener('click', (event) => {
                if (event.target === commentModal) { closeCommentModal(); }
            });
        }

    </script>

</body>
</html>
